<div class="mb-2">
  <%= link_to webposto_dashboard_path, class: "btn btn-outline-secondary btn-sm" do %>
    <i class="fas fa-arrow-left me-1"></i>Voltar
  <% end %>
</div>

<div class="row justify-content-center mb-3">
  <div class="col-12 col-lg-10 col-xl-9">
    <div class="d-flex justify-content-between align-items-start">
      <h2 class="text-success mb-0">
        <i class="fas fa-tools me-2"></i>Gerenciar Técnicos
      </h2>
      <%= link_to "#", class: "btn btn-outline-success btn-sm", onclick: "showRevendaModalTecnicos(); return false;" do %>
        <i class="fas fa-plus me-1"></i>Novo Técnico
      <% end %>
    </div>
  </div>
</div>

<!-- Filtros -->
<div class="row justify-content-center mb-4">
  <div class="col-12 col-lg-10 col-xl-9">
    <div class="card floating-card">
      <div class="card-body p-3">
        <div class="row g-2 align-items-center">
          <div class="col-4">
            <input type="text" id="search-input" class="form-control form-control-sm" 
                   placeholder="Buscar por nome ou email..." 
                   value="<%= params[:search] %>" style="font-size: 0.85rem; height: 32px;">
          </div>
          <div class="col-2">
            <select id="status-filter" class="form-select form-select-sm" style="font-size: 0.85rem; height: 32px;">
              <option value="todos" <%= 'selected' if params[:status].blank? || params[:status] == 'todos' %>>Todos</option>
              <option value="ativos" <%= 'selected' if params[:status] == 'ativos' %>>Ativos</option>
              <option value="inativos" <%= 'selected' if params[:status] == 'inativos' %>>Inativos</option>
            </select>
          </div>
          <div class="col-4">
            <select id="revenda-filter" class="form-select form-select-sm" style="font-size: 0.85rem; height: 32px;">
              <option value="" <%= 'selected' if params[:revenda].blank? %>>Todas as Revendas</option>
              <% @revendas.each do |revenda| %>
                <option value="<%= revenda.id %>" <%= 'selected' if params[:revenda] == revenda.id.to_s %>><%= revenda.nome_fantasia %></option>
              <% end %>
            </select>
          </div>
          <div class="col-2">
            <button type="button" id="clear-filters" class="btn btn-outline-secondary btn-sm w-100" style="font-size: 0.8rem; height: 32px;">
              <i class="fas fa-times"></i> Limpar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row justify-content-center">
  <div class="col-12 col-lg-10 col-xl-9">
    <div class="card floating-card">
      <div class="card-body p-3" id="tecnicos-table" style="max-height: 540px; overflow-y: auto;">
        <%= render 'table', tecnicos: @tecnicos %>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="false">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content border-2 shadow-lg">
      <div class="modal-header border-0 pb-2">
        <h5 class="modal-title" id="confirmModalTitle">Confirmar Ação</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="modalCloseBtn"></button>
      </div>
      <div class="modal-body text-center py-3">
        <div class="mb-3">
          <i id="confirmIcon" class="fas fa-question-circle fa-3x text-warning"></i>
        </div>
        <p id="confirmMessage" class="mb-0 fs-6"></p>
      </div>
      <div class="modal-footer border-0 justify-content-center pt-2">
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-primary btn-sm" id="confirmButton" style="width: 90px; font-size: 0.8rem; padding: 6px 12px;">Confirmar</button>
          <button type="button" class="btn btn-secondary btn-sm" id="cancelButton" style="width: 90px; font-size: 0.8rem; padding: 6px 12px;">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Seleção de Revenda para Técnicos -->
<div class="modal fade" id="revendaModalTecnicos" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 600px;">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title">Selecionar Revenda</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Selecione uma revenda para criar um novo técnico:</p>
        
        <!-- Filtro de busca -->
        <div class="mb-3">
          <input type="text" id="revendaFilterTecnicos" class="form-control" placeholder="Buscar por nome fantasia ou CNPJ...">
        </div>
        
        <div class="list-group" id="revendaListTecnicos" style="height: 210px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem;">
          <% Revenda.active.order(:nome_fantasia).each do |revenda| %>
            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center revenda-item-tecnicos" 
                 data-nome="<%= revenda.nome_fantasia.downcase %>" data-cnpj="<%= revenda.cnpj.downcase %>" 
                 data-url="<%= new_revenda_tecnico_path(revenda, from: 'tecnicos_globais') %>" 
                 onclick="window.location.href='<%= new_revenda_tecnico_path(revenda, from: 'tecnicos_globais') %>'">
              <div>
                <strong><%= revenda.nome_fantasia %></strong><br>
                <small class="text-muted"><%= revenda.cnpj %></small>
              </div>
              <span class="badge bg-success rounded-pill"><%= revenda.tecnicos.active.count %> técnicos</span>
            </div>
          <% end %>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<script>
function initFilters() {
  const searchInput = document.getElementById('search-input');
  const statusFilter = document.getElementById('status-filter');
  const revendaFilter = document.getElementById('revenda-filter');
  const clearButton = document.getElementById('clear-filters');
  
  if (!searchInput) return;
  
  let searchTimeout;

  function applyFilters() {
    const search = searchInput.value;
    const status = statusFilter.value;
    const revenda = revendaFilter.value;
    const tableContainer = document.getElementById('tecnicos-table');
    
    const params = new URLSearchParams();
    if (search) params.set('search', search);
    if (status && status !== 'todos') params.set('status', status);
    if (revenda) params.set('revenda', revenda);
    
    fetch(window.location.pathname + '?' + params.toString(), {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'text/html'
      }
    })
    .then(response => response.text())
    .then(html => {
      tableContainer.innerHTML = html;
    })
    .catch(error => {
      console.error('Erro ao filtrar:', error);
    });
  }

  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(applyFilters, 500);
  });

  statusFilter.addEventListener('change', applyFilters);
  revendaFilter.addEventListener('change', applyFilters);

  clearButton.addEventListener('click', function() {
    searchInput.value = '';
    statusFilter.value = 'todos';
    revendaFilter.value = '';
    applyFilters();
  });
}

// Handler para toggle status com modal
document.addEventListener('click', function(e) {
  if (e.target.closest('.toggle-tecnico-btn')) {
    e.preventDefault();
    const btn = e.target.closest('.toggle-tecnico-btn');
    const tecnicoId = btn.dataset.tecnicoId;
    const action = btn.dataset.action;
    
    // Configurar modal
    const modalElement = document.getElementById('confirmModal');
    const modal = new bootstrap.Modal(modalElement, {
      backdrop: false,
      keyboard: true
    });
    const confirmButton = document.getElementById('confirmButton');
    const cancelButton = document.getElementById('cancelButton');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmIcon = document.getElementById('confirmIcon');
    
    // Personalizar modal baseado na ação
    if (action === 'desativar') {
      confirmMessage.textContent = 'Tem certeza que deseja desativar este técnico?';
      confirmIcon.className = 'fas fa-exclamation-triangle fa-3x text-warning';
      confirmButton.className = 'btn btn-primary btn-sm';
      confirmButton.textContent = 'Confirmar';
    } else {
      confirmMessage.textContent = 'Tem certeza que deseja ativar este técnico?';
      confirmIcon.className = 'fas fa-check-circle fa-3x text-success';
      confirmButton.className = 'btn btn-primary btn-sm';
      confirmButton.textContent = 'Confirmar';
    }
    
    // Remover listeners anteriores e adicionar novo
    const newConfirmButton = confirmButton.cloneNode(true);
    confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
    
    newConfirmButton.addEventListener('click', function() {
      // Fazer requisição
      fetch(`/tecnicos/${tecnicoId}/toggle_status`, {
        method: 'PATCH',
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        }
      })
      .then(response => {
        modal.hide();
        if (response.ok) {
          return response.json();
        } else {
          throw new Error('Erro na requisição');
        }
      })
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('Erro ao alterar status do técnico');
        }
      })
      .catch(error => {
        modal.hide();
        console.error('Erro:', error);
        alert('Erro ao alterar status do técnico');
      });
    });
    
    modal.show();
  }
});

// Função para mostrar modal de seleção de revenda para técnicos
function showRevendaModalTecnicos() {
  const modal = new bootstrap.Modal(document.getElementById('revendaModalTecnicos'));
  modal.show();
  
  setTimeout(() => {
    const filterInput = document.getElementById('revendaFilterTecnicos');
    filterInput.value = '';
    filterInput.focus();
  }, 100);
}

// Filtro para modal de técnicos
document.addEventListener('DOMContentLoaded', function() {
  initFilters();
  
  const filterInput = document.getElementById('revendaFilterTecnicos');
  if (filterInput) {
    const originalItems = [];
    const container = document.getElementById('revendaListTecnicos');
    
    document.querySelectorAll('.revenda-item-tecnicos').forEach(item => {
      originalItems.push(item.cloneNode(true));
    });
    
    filterInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase().trim();
      
      container.innerHTML = '';
      
      const filteredItems = originalItems.filter(item => {
        const nome = item.dataset.nome || '';
        const cnpj = item.dataset.cnpj || '';
        return nome.includes(searchTerm) || cnpj.includes(searchTerm);
      });
      
      filteredItems.forEach(item => {
        const newItem = item.cloneNode(true);
        newItem.onclick = function() {
          window.location.href = newItem.dataset.url;
        };
        container.appendChild(newItem);
      });
      
      if (filteredItems.length === 0 && searchTerm.length > 0) {
        container.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-search"></i><br>Nenhuma revenda encontrada</div>';
      }
    });
  }
});

document.addEventListener('turbo:load', function() {
  initFilters();
});
</script>
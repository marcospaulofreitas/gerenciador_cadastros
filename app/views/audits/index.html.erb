<!-- Notificações Flash -->
<% if flash[:notice] %>
  <div class="alert alert-success" role="alert" style="position: fixed; top: 80px; right: 20px; z-index: 9999; font-size: 0.8rem; padding: 0.5rem; max-width: 300px;">
    <%= flash[:notice] %>
  </div>
<% end %>

<% if flash[:alert] %>
  <div class="alert alert-danger" role="alert" style="position: fixed; top: 80px; right: 20px; z-index: 9999; font-size: 0.8rem; padding: 0.5rem; max-width: 300px;">
    <%= flash[:alert] %>
  </div>
<% end %>

<div class="mb-2">
  <%= link_to webposto_dashboard_path, class: "btn btn-outline-secondary btn-sm" do %>
    <i class="fas fa-arrow-left me-1"></i>Voltar
  <% end %>
</div>
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="text-primary mb-0">
    <i class="fas fa-clock me-2"></i>Alterações Pendentes
  </h3>
  <div>
    <% if @audits.any? %>
      <%= link_to approve_all_audits_path, method: :patch, class: "btn btn-success", 
          data: { confirm: "Aprovar todas as #{@audits.count} alterações pendentes?" } do %>
        <i class="fas fa-check-double me-1"></i>Aprovar Todas
      <% end %>
    <% end %>
  </div>
</div>

<div class="card floating-card">
  <div class="card-body">
    <% if @audits.any? %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Técnico</th>
              <th>Revenda</th>
              <th>Ação</th>
              <th>Item</th>
              <th>Alterações</th>
              <th>Data/Hora</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            <% @audits.each do |audit| %>
              <tr>
                <td>
                  <strong><%= audit.tecnico.name %></strong><br>
                  <small class="text-muted"><%= audit.tecnico.funcao_humanized %></small>
                </td>
                <td>
                  <small><%= audit.tecnico.revenda.nome_fantasia %></small>
                </td>
                <td>
                  <span class="badge bg-<%= audit.action == 'create' ? 'success' : audit.action == 'update' ? 'warning' : 'danger' %>">
                    <%= audit.action_description %>
                  </span>
                </td>
                <td>
                  <small><%= audit.auditable_type %> #<%= audit.auditable_id %></small>
                </td>
                <td>
                  <small><%= truncate(audit.changes_summary, length: 60) %></small>
                </td>
                <td>
                  <small><%= audit.created_at.strftime("%d/%m/%Y %H:%M") %></small>
                </td>
                <td>
                  <%= link_to approve_audit_path(audit), method: :patch, 
                      class: "btn btn-sm btn-success", 
                      data: { confirm: "Aprovar esta alteração?" } do %>
                    <i class="fas fa-check"></i>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center text-muted py-5">
        <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
        <h4>Nenhuma alteração pendente</h4>
        <p>Todas as alterações dos técnicos foram aprovadas!</p>
      </div>
    <% end %>
  </div>
</div>

<script>
// Auto-hide alerts após 3 segundos
document.addEventListener('DOMContentLoaded', function() {
  const alerts = document.querySelectorAll('.alert');
  alerts.forEach(function(alert) {
    setTimeout(function() {
      if (alert && alert.parentNode) {
        alert.style.transition = 'opacity 0.5s';
        alert.style.opacity = '0';
        setTimeout(function() {
          if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
          }
        }, 500);
      }
    }, 3000);
  });
});
</script>
<div class="mb-2">
  <%= link_to (params[:from] == 'tecnicos_globais' ? tecnicos_globais_path : revenda_tecnicos_path(@revenda)), class: "btn btn-outline-secondary btn-sm" do %>
    <i class="fas fa-arrow-left me-1"></i>Voltar
  <% end %>
</div>
<div class="row justify-content-center mb-3">
  <div class="col-12 col-lg-8 col-xl-7">
    <h3 class="text-success mb-0">
      <i class="fas fa-user me-2"></i><%= @tecnico.name %>
    </h3>
  </div>
</div>

<div class="row justify-content-center">
  <div class="col-12 col-lg-8 col-xl-7">
    <div class="card floating-card">
      <div class="card-header bg-success text-white d-flex justify-content-between align-items-center" style="height: 45px;">
        <h6 class="mb-0"><i class="fas fa-user me-2"></i>Informações do Técnico</h6>
        <div class="d-flex gap-1">
          <%= link_to edit_revenda_tecnico_path(@revenda, @tecnico), class: "btn btn-warning btn-sm", style: "height: 30px; font-size: 0.75rem; padding: 4px 10px;",
              title: "Alterar dados do técnico", data: { bs_toggle: "tooltip", bs_placement: "bottom" } do %>
            <i class="fas fa-edit me-1"></i>Alterar
          <% end %>
          <%= link_to "#", class: "btn btn-outline-light btn-sm toggle-tecnico-btn", style: "height: 30px; font-size: 0.75rem; padding: 4px 10px; border-color: #fff;",
              title: "#{@tecnico.active? ? 'Desativar' : 'Ativar'} técnico", data: { bs_toggle: "tooltip", bs_placement: "bottom", tecnico_id: @tecnico.id, action: @tecnico.active? ? 'desativar' : 'ativar' } do %>
            <% if @tecnico.active? %>
              <i class="fas fa-ban me-1"></i>Desativar
            <% else %>
              <i class="fas fa-check me-1"></i>Ativar
            <% end %>
          <% end %>
        </div>
      </div>
      <div class="card-body p-2">
        <div class="row g-1">
          <!-- Nome e Email -->
          <div class="col-6">
            <small class="text-muted" style="font-size: 0.7rem;">Nome:</small><br>
            <strong style="font-size: 0.75rem;"><%= @tecnico.name %></strong>
          </div>
          <div class="col-6">
            <small class="text-muted" style="font-size: 0.7rem;">Email:</small><br>
            <strong style="font-size: 0.75rem;"><%= @tecnico.email %></strong>
          </div>
          
          <!-- Telefone e Username -->
          <div class="col-6">
            <small class="text-muted" style="font-size: 0.7rem;">Telefone:</small><br>
            <strong style="font-size: 0.75rem;"><%= @tecnico.telefone %></strong>
          </div>
          <div class="col-6">
            <small class="text-muted" style="font-size: 0.7rem;">Username:</small><br>
            <strong style="font-size: 0.75rem;"><%= @tecnico.username %></strong>
          </div>
          
          <!-- Função e Perfil -->
          <div class="col-6">
            <small class="text-muted" style="font-size: 0.7rem;">Função:</small><br>
            <strong style="font-size: 0.75rem;"><%= @tecnico.funcao_humanized %></strong>
          </div>
          <div class="col-6">
            <small class="text-muted" style="font-size: 0.7rem;">Perfil de Acesso:</small><br>
            <span class="badge bg-<%= @tecnico.administrador? ? 'primary' : 'secondary' %>" style="font-size: 0.65rem;">
              <%= @tecnico.administrador? ? 'Administrador' : 'Técnico' %>
            </span>
          </div>
          
          <!-- Especialista e Status -->
          <div class="col-6">
            <small class="text-muted" style="font-size: 0.7rem;">Especialista:</small><br>
            <% if @tecnico.especialista? %>
              <i class="fas fa-star text-warning me-1"></i><strong style="font-size: 0.75rem;">Sim</strong>
            <% else %>
              <i class="fas fa-star text-muted me-1"></i><strong style="font-size: 0.75rem;">Não</strong>
            <% end %>
          </div>
          <div class="col-6">
            <small class="text-muted" style="font-size: 0.7rem;">Status:</small><br>
            <span class="badge bg-<%= @tecnico.active? ? 'success' : 'danger' %>" style="font-size: 0.65rem;">
              <%= @tecnico.active? ? 'Ativo' : 'Inativo' %>
            </span>
          </div>
          
          <!-- Revenda -->
          <div class="col-12">
            <small class="text-muted" style="font-size: 0.7rem;">Revenda:</small><br>
            <strong style="font-size: 0.75rem;"><%= @tecnico.revenda.nome_fantasia %> - <%= @tecnico.revenda.cnpj_formatted %></strong>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="false">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content border-2 shadow-lg">
      <div class="modal-header border-0 pb-2">
        <h5 class="modal-title">Confirmar Ação</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center py-3">
        <div class="mb-3">
          <i id="confirmIcon" class="fas fa-question-circle fa-3x text-warning"></i>
        </div>
        <p id="confirmMessage" class="mb-0 fs-6"></p>
      </div>
      <div class="modal-footer border-0 justify-content-center pt-2">
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-primary btn-sm" id="confirmButton" style="width: 90px; font-size: 0.8rem; padding: 6px 12px;">Confirmar</button>
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal" style="width: 90px; font-size: 0.8rem; padding: 6px 12px;">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('click', function(e) {
  if (e.target.closest('.toggle-tecnico-btn')) {
    e.preventDefault();
    const btn = e.target.closest('.toggle-tecnico-btn');
    const tecnicoId = btn.dataset.tecnicoId;
    const action = btn.dataset.action;
    
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'), { backdrop: false });
    const confirmButton = document.getElementById('confirmButton');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmIcon = document.getElementById('confirmIcon');
    
    if (action === 'desativar') {
      confirmMessage.textContent = 'Tem certeza que deseja desativar este técnico?';
      confirmIcon.className = 'fas fa-exclamation-triangle fa-3x text-warning';
      confirmButton.className = 'btn btn-danger btn-sm';
      confirmButton.textContent = 'Desativar';
    } else {
      confirmMessage.textContent = 'Tem certeza que deseja ativar este técnico?';
      confirmIcon.className = 'fas fa-check-circle fa-3x text-success';
      confirmButton.className = 'btn btn-success btn-sm';
      confirmButton.textContent = 'Ativar';
    }
    
    const newConfirmButton = confirmButton.cloneNode(true);
    confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
    
    newConfirmButton.addEventListener('click', function() {
      fetch(`/revendas/<%= @revenda.id %>/tecnicos/${tecnicoId}/toggle_status`, {
        method: 'PATCH',
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        modal.hide();
        if (data.success) {
          location.reload();
        } else {
          alert('Erro ao alterar status do técnico');
        }
      })
      .catch(error => {
        modal.hide();
        alert('Erro ao alterar status do técnico');
      });
    });
    
    modal.show();
  }
});
</script>
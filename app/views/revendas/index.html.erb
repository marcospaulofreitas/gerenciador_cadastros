<div class="mb-2">
  <%= link_to webposto_dashboard_path, class: "btn btn-outline-secondary btn-sm" do %>
    <i class="fas fa-arrow-left me-1"></i>Voltar
  <% end %>
</div>
<div class="mb-3">
  <div class="d-flex justify-content-between align-items-start">
    <h2 class="text-primary mb-0">
      <i class="fas fa-store me-2"></i>Gerenciar Revendas
    </h2>
  </div>
  <div class="d-flex justify-content-end mt-2">
    <%= link_to new_revenda_path, class: "btn btn-outline-primary btn-sm", 
        title: "Cadastrar nova revenda", data: { bs_toggle: "tooltip", bs_placement: "bottom" } do %>
      <i class="fas fa-plus me-1"></i>Nova Revenda
    <% end %>
  </div>
</div>

<!-- Filtros -->
<div class="card floating-card mb-4">
  <div class="card-body p-3">
    <div class="row g-2 align-items-center">
      <div class="col-4">
        <input type="text" id="search-input" class="form-control form-control-sm" 
               placeholder="Buscar por nome ou CNPJ..." 
               value="<%= params[:search] %>" style="font-size: 0.85rem; height: 32px;">
      </div>
      <div class="col-2">
        <select id="status-filter" class="form-select form-select-sm" style="font-size: 0.85rem; height: 32px;">
          <option value="todas" <%= 'selected' if params[:status].blank? || params[:status] == 'todas' %>>Todas</option>
          <option value="ativas" <%= 'selected' if params[:status] == 'ativas' %>>Ativas</option>
          <option value="inativas" <%= 'selected' if params[:status] == 'inativas' %>>Inativas</option>
        </select>
      </div>
      <div class="col-4">
        <select id="gerente-filter" class="form-select form-select-sm" style="font-size: 0.85rem; height: 32px;">
          <option value="" <%= 'selected' if params[:gerente].blank? %>>Todos os Gerentes</option>
          <% @gerentes.each do |gerente| %>
            <option value="<%= gerente.id %>" <%= 'selected' if params[:gerente] == gerente.id.to_s %>><%= gerente.name %></option>
          <% end %>
        </select>
      </div>
      <div class="col-2">
        <button type="button" id="clear-filters" class="btn btn-outline-secondary btn-sm w-100" style="font-size: 0.8rem; height: 32px;">
          <i class="fas fa-times"></i> Limpar
        </button>
      </div>
    </div>
  </div>
</div>

<div class="card floating-card">
  <div class="card-body p-3" id="revendas-table">
    <%= render 'table', revendas: @revendas %>
  </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="false">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content border-2 shadow-lg">
      <div class="modal-header border-0 pb-2">
        <h5 class="modal-title" id="confirmModalTitle">Confirmar Ação</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="modalCloseBtn"></button>
      </div>
      <div class="modal-body text-center py-3">
        <div class="mb-3">
          <i id="confirmIcon" class="fas fa-question-circle fa-3x text-warning"></i>
        </div>
        <p id="confirmMessage" class="mb-0 fs-6"></p>
      </div>
      <div class="modal-footer border-0 justify-content-center pt-2">
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-primary btn-sm" id="confirmButton" style="width: 90px; font-size: 0.8rem; padding: 6px 12px;">Confirmar</button>
          <button type="button" class="btn btn-secondary btn-sm" id="cancelButton" style="width: 90px; font-size: 0.8rem; padding: 6px 12px;">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function initFilters() {
  const searchInput = document.getElementById('search-input');
  const statusFilter = document.getElementById('status-filter');
  const gerenteFilter = document.getElementById('gerente-filter');
  const clearButton = document.getElementById('clear-filters');
  
  if (!searchInput) return;
  
  let searchTimeout;

  function applyFilters() {
    const search = searchInput.value;
    const status = statusFilter.value;
    const gerente = gerenteFilter.value;
    const tableContainer = document.getElementById('revendas-table');
    
    const params = new URLSearchParams();
    if (search) params.set('search', search);
    if (status && status !== 'todas') params.set('status', status);
    if (gerente) params.set('gerente', gerente);
    
    fetch(window.location.pathname + '?' + params.toString(), {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'text/html'
      }
    })
    .then(response => response.text())
    .then(html => {
      tableContainer.innerHTML = html;
    })
    .catch(error => {
      console.error('Erro ao filtrar:', error);
    });
  }

  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(applyFilters, 500);
  });

  statusFilter.addEventListener('change', applyFilters);
  gerenteFilter.addEventListener('change', applyFilters);

  clearButton.addEventListener('click', function() {
    searchInput.value = '';
    statusFilter.value = 'todas';
    gerenteFilter.value = '';
    applyFilters();
  });
}

// Handler para toggle status com modal
document.addEventListener('click', function(e) {
  if (e.target.closest('.toggle-revenda-btn')) {
    e.preventDefault();
    const btn = e.target.closest('.toggle-revenda-btn');
    const revendaId = btn.dataset.revendaId;
    const action = btn.dataset.action;
    
    // Configurar modal
    const modalElement = document.getElementById('confirmModal');
    const modal = new bootstrap.Modal(modalElement, {
      backdrop: false,
      keyboard: true
    });
    
    const confirmButton = document.getElementById('confirmButton');
    const cancelButton = document.getElementById('cancelButton');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmIcon = document.getElementById('confirmIcon');
    
    // Personalizar modal baseado na ação
    if (action === 'desativar') {
      confirmMessage.textContent = 'Tem certeza que deseja desativar esta revenda?';
      confirmIcon.className = 'fas fa-exclamation-triangle fa-3x text-warning';
      confirmButton.className = 'btn btn-danger btn-sm';
      confirmButton.textContent = 'Desativar';
    } else {
      confirmMessage.textContent = 'Tem certeza que deseja ativar esta revenda?';
      confirmIcon.className = 'fas fa-check-circle fa-3x text-success';
      confirmButton.className = 'btn btn-success btn-sm';
      confirmButton.textContent = 'Ativar';
    }
    
    // Função para fechar modal
    function closeModal() {
      modal.hide();
    }
    
    // Remover listeners anteriores
    const newConfirmButton = confirmButton.cloneNode(true);
    const newCancelButton = cancelButton.cloneNode(true);
    confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
    cancelButton.parentNode.replaceChild(newCancelButton, cancelButton);
    
    // Adicionar listener para confirmar
    newConfirmButton.addEventListener('click', function() {
      newConfirmButton.disabled = true;
      newConfirmButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
      
      fetch(`/revendas/${revendaId}/toggle_status`, {
        method: 'PATCH',
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        }
      })
      .then(response => {
        if (response.ok) {
          return response.json();
        } else {
          throw new Error('Erro na requisição');
        }
      })
      .then(data => {
        closeModal();
        if (data.success) {
          location.reload();
        } else {
          alert('Erro ao alterar status da revenda');
        }
      })
      .catch(error => {
        closeModal();
        console.error('Erro:', error);
        alert('Erro ao alterar status da revenda');
      });
    });
    
    // Adicionar listener para cancelar
    newCancelButton.addEventListener('click', closeModal);
    
    // Adicionar listener para botão X
    document.getElementById('modalCloseBtn').addEventListener('click', closeModal);
    
    // Adicionar listener para ESC
    document.addEventListener('keydown', function escHandler(e) {
      if (e.key === 'Escape') {
        closeModal();
        document.removeEventListener('keydown', escHandler);
      }
    });
    
    modal.show();
  }
});

document.addEventListener('DOMContentLoaded', initFilters);
document.addEventListener('turbo:load', initFilters);
</script>

<style>
/* Modal sem backdrop - melhorar visibilidade */
#confirmModal .modal-content {
  border: 2px solid #007bff;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
  from {
    transform: translateY(-50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* Responsividade do modal */
@media (max-width: 576px) {
  #confirmModal .modal-dialog {
    margin: 1rem;
    max-width: calc(100% - 2rem);
  }
  
  #confirmModal .modal-content {
    border-width: 1px;
  }
  
  #confirmModal .modal-body p {
    font-size: 0.9rem;
  }
  
  #confirmModal .modal-footer button {
    width: 80px !important;
    font-size: 0.75rem !important;
    padding: 4px 8px !important;
  }
}

/* Melhorar contraste dos botões */
#confirmModal .btn-danger {
  background-color: #dc3545;
  border-color: #dc3545;
}

#confirmModal .btn-success {
  background-color: #198754;
  border-color: #198754;
}

#confirmModal .btn:disabled {
  opacity: 0.7;
}
</style>